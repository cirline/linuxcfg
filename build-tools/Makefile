# 
build_path	:= $(shell pwd)
home_path	:= $$HOME
install_path	:= $(home_path)/linuxcfg/home/tools

# function
echo_info	= @echo "\033[34m $(1) \033[0m"
echo_err	= @echo "\033[31m $(1) \033[0m"
echo_success	= @echo "\033[32m $(1) \033[0m"

# make config file
config_file		:= build.config
defconfig_file	:= user/build_defconfig.mk
config_exist	:= $(shell if [ -f $(config_file) ]; then echo 1; fi)

ifdef config_exist
include $(config_file)
else
config_error:
	$(call echo_err, "cannot find $(config_file)")
	make defconfig
endif

include $(defconfig_file)

build			:= build.out
build_objs		:= build.l

tools_install	:= simple-tools
tools_out	:= $(tools_install).out
ui_install	:= $(tools_install).ui
ui_out		:= $(ui_install).out
tools_config	:= simple-tools.config

objs	:=
objs	+= $(tools_config)
objs	+= simple-tools.common
objs	+= simple-tools.misc
objs	+= mount.sh
objs	+= simple-tools.linkcommand
objs	+= simple-tools.android
objs	+= customization.sh
objs	+= sh/main.sh
objs	+= sh/misc.sh
objs	+= sh/link.sh
objs	+= sh/rawmode.sh
objs	+= sh/mount.sh
objs	+= sh/common.sh

mobj	:= simple-tools.main

ui_objs	:=
ui_objs += simple-tools.wxui

dirs	:=
dirs	+= $(out_path)

all: $(tools_out) $(ui_out)
	$(call echo_success, "all finish")

onekey:
	make
	make install
	$(call echo_success, "onekey make finish")

# begin build
$(tools_out): $(build) $(dirs) $(config_file) $(objs) $(mobj)
	$(build_path)/$(build) $@ $(mobj)
	chmod 755 $@
	$(call echo_success, "make $(tools_out) success")

$(ui_out): $(ui_objs)
	$(build_path)/$(build) $@ $(ui_objs)
	chmod 755 $@
	$(call echo_success, "make $(ui_out) success")

$(dirs):
	$(call echo_info, "checking directory")
	@if [ ! -d $(out_path) ]; then mkdir $(out_path); fi

$(tools_config): $(config_file)
	$(call echo_info, "create simple-tools config")
	@echo "#!/bin/bash" > $@
	@echo "# do not edit this file, file created auto" >> $@
	@echo "# $(config_file): local config file" >> $@
	@echo "# $(defconfig_file): default config file" >> $@
	@echo "tools_debug=$(tools_debug)" >> $@
	@echo "efs_data_path=$(efs_data_path)" >> $@
	@echo "efs_mnt_path=$(efs_mnt_path)" >> $@
	@echo "android_phone_setting=$(android_phone_setting)" >> $@
	@echo "do_before_leaving_config=$(do_before_leaving_config)" >> $@
	@echo "ct_path=$(ct_path)" >> $@
	@echo "jcloud_path=$(jcloud_path)" >> $@
	@echo "ecrypt_sync_dir_mount=$(ecrypt_sync_dir_mount)" >> $@
	@echo "ecrypt_sync_dir_data=$(ecrypt_sync_dir_data)" >> $@

config: $(config_file)

$(config_file): $(defconfig_file)
	$(call echo_info, "$(defconfig_file) is changed ~ ")
	cat $(defconfig_file) >> $(config_file)

defconfig: $(defconfig_file)
	$(call echo_info, "copy default config file")
	cp $(defconfig_file) $(config_file)

$(build): build.l
	flex -o lex.yy.c $^
	gcc -o $@ lex.yy.c -lfl

distclean:
	make clean
	rm *.config

clean:
	rm *.out lex.yy.c

install:
	cp $(tools_out) $(install_path)/$(tools_install)
	$(install_path)/$(tools_install) clink $(install_path)
	cp $(ui_out) $(install_path)/$(ui_install)

.PHONY: all onekey config defconfig distclean clean install

